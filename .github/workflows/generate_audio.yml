name: Generate Store Audio

# This allows you to run the workflow manually from the "Actions" tab in GitHub
on:
  workflow_dispatch:

jobs:
  build-and-run:
    # Use the latest Ubuntu runner
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      - name: 2. Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' # A stable Python version

      - name: 3. Install System Dependencies (ffmpeg & piper)
        run: |
          # Update package list and install ffmpeg (for audio conversion)
          sudo apt-get update
          sudo apt-get install -y ffmpeg wget
          
          # Download the Piper TTS binary (tar.gz archive)
          echo "Downloading Piper TTS binary..."
          # --- CORRECTED URL: Pointing to the LATEST v1.3.0 release ---
          wget https://github.com/rhasspy/piper/releases/download/v1.3.0/piper-linux-x86_64.tar.gz
          
          echo "Extracting Piper TTS..."
          # Extract the tar.gz archive
          tar -zxvf piper-linux-x86_64.tar.gz
          
          echo "Installing Piper TTS to /usr/bin/..."
          # Move the 'piper' binary to a directory in the system PATH
          sudo mv ./piper-linux-x86_64/piper /usr/bin/
          
          # Clean up the downloaded archive and extracted folder
          echo "Cleaning up installer files..."
          rm piper-linux-x86_64.tar.gz
          rm -r ./piper-linux-x86_64
          
          # Verify installations
          echo "Verifying installations..."
          ffmpeg -version
          piper --version

      - name: 4. Install Python Libraries
        run: |
          python -m pip install --upgrade pip
          # Install only the libraries required for the voice-only script
          pip install pandas requests gtts gspread google-api-python-client google-auth

      - name: 5. Run Audio Generation Script
        env:
          # This securely passes your GitHub Secret (named GCP_SA_KEY) 
          # to the environment variable the script expects.
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          # Run the Python script
          python generate_audio.py
