name: Generate Store Audio

on:
  workflow_dispatch:

jobs:
  build-and-run:
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      - name: 2. Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: 3. Install System Dependencies (ffmpeg & piper)
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y ffmpeg wget

          echo "Downloading Piper TTS binary (v1.2.0)..."
          # Correct asset name for v1.2.0 on x86_64
          wget https://github.com/rhasspy/piper/releases/download/v1.2.0/piper_amd64.tar.gz

          echo "Extracting Piper TTS..."
          tar -zxvf piper_amd64.tar.gz

          echo "Installing Piper TTS to /usr/bin/..."
          sudo mv ./piper/piper /usr/bin/

          echo "Cleaning up installer files..."
          rm piper_amd64.tar.gz
          rm -r ./piper

          echo "Verifying installations..."
          ffmpeg -version
          piper --version || true

      - name: 3b. (Optional) Download a sample voice for health check
        run: |
          set -e
          mkdir -p voices
          wget -O voices/en_US-amy-medium.onnx \
            https://huggingface.co/rhasspy/piper-voices/resolve/v1.0.0/en/en_US/amy/medium/en_US-amy-medium.onnx
          wget -O voices/en_US-amy-medium.onnx.json \
            https://huggingface.co/rhasspy/piper-voices/resolve/v1.0.0/en/en_US/amy/medium/en_US-amy-medium.onnx.json

      - name: 3c. Health check Piper (generate a short WAV)
        run: |
          set -e
          echo "Hello from Piper TTS (v1.2.0)" | piper --model voices/en_US-amy-medium.onnx --output_file hello.wav
          test -f hello.wav && ls -lh hello.wav

      - name: 4. Install Python Libraries
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests gtts gspread google-api-python-client google-auth

      - name: 5. Run Audio Generation Script
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          python generate_audio.py
