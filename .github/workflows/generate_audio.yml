name: Generate Store Audio

# This allows you to run the workflow manually from the "Actions" tab in GitHub
on:
  workflow_dispatch:

jobs:
  build-and-run:
    # Use the latest Ubuntu runner
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      - name: 2. Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' # A stable Python version

      - name: 3. Install System Dependencies (ffmpeg & piper)
        run: |
          # Update package list and install ffmpeg (for audio conversion)
          sudo apt-get update
          sudo apt-get install -y ffmpeg wget
          
          # Download and install the Piper TTS binary (required by your script)
          echo "Downloading Piper TTS binary..."
          wget https://github.com/rhasspy/piper/releases/download/v1.2.0/piper_1.2.0_amd64.deb
          
          echo "Installing Piper TTS..."
          # Use 'apt-get install -f' to automatically fetch any missing dependencies for the .deb file
          sudo dpkg -i ./piper_1.2.0_amd64.deb || sudo apt-get install -f -y
          
          # Verify installations
          echo "Verifying installations..."
          ffmpeg -version
          piper --version

      - name: 4. Install Python Libraries
        run: |
          python -m pip install --upgrade pip
          # Install only the libraries required for the voice-only script
          pip install pandas requests gtts gspread google-api-python-client google-auth

      - name: 5. Run Audio Generation Script
        env:
          # This securely passes your GitHub Secret (named GCP_SA_KEY) 
          # to the environment variable the script expects.
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          # Run the Python script
          python generate_audio.py
