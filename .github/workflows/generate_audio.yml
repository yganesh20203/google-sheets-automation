name: Generate Store Audio

on:
  workflow_dispatch:

jobs:
  build-and-run:
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      - name: 2. Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'  # Piper 1.3 wheels use Python stable ABI (3.9+) [1](https://github.com/OHF-Voice/piper1-gpl/releases)

      - name: 3. Install system dependencies (ffmpeg, wget)
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y ffmpeg wget

      - name: 4. Install Python packages (Piper 1.x + your libs)
        run: |
          set -e
          python -m pip install --upgrade pip
          # Install maintained Piper 1.x (GPL) and your script deps
          pip install "piper-tts>=1.3.0" pandas requests gtts gspread google-api-python-client google-auth
          # Show Piper CLI help/version (invoked via the Python module entry point)
          python -m piper --help >/dev/null
          python -m piper --version || true

      - name: 5. Download a voice (Amy, en_US, medium) to ./voices
        run: |
          set -e
          mkdir -p voices
          # Use built-in downloader (stores .onnx and .onnx.json in --data-dir)
          python -m piper.download_voices en_US-amy-medium --data-dir voices
        # Voice downloader is part of Piper 1.3 docs/CLI flow [3](https://github.com/OHF-Voice/piper1-gpl/blob/main/docs/CLI.md)

      - name: 6. Health check Piper (generate a short WAV)
        run: |
          set -e
          # Synthesize to WAV using the voice ID from --data-dir
          python -m piper --data-dir voices -m en_US-amy-medium -f hello.wav -- "Hello from Piper one point three."
          test -f hello.wav && file hello.wav && ls -lh hello.wav
        # CLI usage: -m for model (voice id or .onnx path), -f for output file, text after -- [3](https://github.com/OHF-Voice/piper1-gpl/blob/main/docs/CLI.md)

      - name: 7. Run Audio Generation Script
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          # If your script shells out to `piper`, prefer `python -m piper` for clarity.
          # Ensure it either uses the same ./voices directory or downloads its own voices.
